on:
  pull_request:
  workflow_dispatch:
    inputs:
      DEPLOY:
        type: boolean
        description: Deploy artifacts
        default: false
        required: false

env:
  IS_DEPLOYABLE: ${{ (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/production' || inputs.DEPLOY) && true || false }}

jobs:
  up:
    runs-on: ubuntu-22.04
    #runs-on: macos-13
    concurrency:
      group: ${{ (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/production' || inputs.DEPLOY) && 'concurrency-counter-increment' || github.run_id }}
      cancel-in-progress: ${{ (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/production' || inputs.DEPLOY) && false || true }}
    steps:
      - name: Echo
        run: |
          echo $RUNNER_TEMP
          echo "github.repository: ${{ github.repository }}"
          echo "github.ref: ${{ github.ref }}"
          echo "Is fork: ${{ github.event.pull_request.head.repo.fork == true }}"
          echo "Repo: ${{ github.event.pull_request.head.repo.full_name }}"
          echo "Ref: ${{ github.head_ref || github.ref_name }}"
          echo "Deploy: ${{ inputs.DEPLOY }}"
          echo "Is deploy: ${{ inputs.DEPLOY && 'yes' || 'no' }}"
          echo "IS_DEPLOYABLE: ${{ env.IS_DEPLOYABLE }}"
          echo "Is main: ${{ github.ref == 'refs/heads/main' && 'yes' || 'no' }}"
          echo "Is production: ${{ github.ref == 'refs/heads/production' && 'yes' || 'no' }}"
          echo "Concurrency group: ${{ (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/production' || inputs.DEPLOY) && 'concurrency-counter-increment' || github.run_id }}"
          echo "Cancel in progress: ${{ (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/production' || inputs.DEPLOY) && false || true }}"

      - name: Counter
        id: incremented
        run: |
          NUM=$(("${{ vars.NUM }}" + 1))
          echo "Var sum: $NUM"
          echo "number=$NUM" >> "$GITHUB_OUTPUT"

      - name: Update vars.NUM
        if: success() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/production' || inputs.DEPLOY == true)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT }}
          script: |
            github.rest.actions.updateRepoVariable({ 
              "owner": "${{ github.repository_owner }}", 
              "repo": "${{ github.event.repository.name }}",
              "name": "NUM", 
              "value": "${{ steps.incremented.outputs.number }}" 
            });
            
      - name: Sleep
        run: |
          sleep 30
